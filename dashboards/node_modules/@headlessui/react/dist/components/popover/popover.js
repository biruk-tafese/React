"use client";import{useFocusRing as Oe}from"@react-aria/focus";import{useHover as Ce}from"@react-aria/interactions";import y,{Fragment as Me,createContext as ee,createRef as me,useContext as te,useEffect as oe,useMemo as D,useReducer as xe,useRef as z,useState as ye}from"react";import{useActivePress as _e}from'../../hooks/use-active-press.js';import{useEvent as g}from'../../hooks/use-event.js';import{useEventListener as Le}from'../../hooks/use-event-listener.js';import{useId as re}from'../../hooks/use-id.js';import{useIsoMorphicEffect as Ie}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ee}from'../../hooks/use-latest-value.js';import{useOutsideClick as Be}from'../../hooks/use-outside-click.js';import{useOwnerDocument as se}from'../../hooks/use-owner.js';import{useResolveButtonType as he}from'../../hooks/use-resolve-button-type.js';import{useMainTreeNode as De,useRootContainers as Ge}from'../../hooks/use-root-containers.js';import{optionalRef as He,useSyncRefs as Y}from'../../hooks/use-sync-refs.js';import{Direction as H,useTabDirection as be}from'../../hooks/use-tab-direction.js';import{FloatingProvider as Ne,useFloatingPanel as ke,useFloatingPanelProps as we,useFloatingReference as Ue}from'../../internal/floating.js';import{Hidden as ue,HiddenFeatures as ie}from'../../internal/hidden.js';import{Modal as ge,ModalFeatures as We}from'../../internal/modal.js';import{OpenClosedProvider as Ve,State as q,useOpenClosed as Se}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as Ae}from'../../utils/bugs.js';import{Focus as N,FocusResult as fe,FocusableMode as Ke,focusIn as W,getFocusableElements as Pe,isFocusableElement as je}from'../../utils/focus-management.js';import{match as V}from'../../utils/match.js';import'../../utils/micro-task.js';import{getOwnerDocument as $e}from'../../utils/owner.js';import{RenderFeatures as ne,forwardRefWithAs as Q,mergeProps as de,render as Z,useMergeRefsFn as Je}from'../../utils/render.js';import{FocusTrapFeatures as Xe}from'../focus-trap/focus-trap.js';import{Keys as K}from'../keyboard.js';import{Portal as Re,useNestedPortals as Ye}from'../portal/portal.js';var qe=(f=>(f[f.Open=0]="Open",f[f.Closed=1]="Closed",f))(qe||{}),ze=(n=>(n[n.TogglePopover=0]="TogglePopover",n[n.ClosePopover=1]="ClosePopover",n[n.SetButton=2]="SetButton",n[n.SetButtonId=3]="SetButtonId",n[n.SetPanel=4]="SetPanel",n[n.SetPanelId=5]="SetPanelId",n))(ze||{});let Qe={[0]:e=>{let a={...e,popoverState:V(e.popoverState,{[0]:1,[1]:0})};return a.popoverState===0&&(a.__demoMode=!1),a},[1](e){return e.popoverState===1?e:{...e,popoverState:1}},[2](e,a){return e.button===a.button?e:{...e,button:a.button}},[3](e,a){return e.buttonId===a.buttonId?e:{...e,buttonId:a.buttonId}},[4](e,a){return e.panel===a.panel?e:{...e,panel:a.panel}},[5](e,a){return e.panelId===a.panelId?e:{...e,panelId:a.panelId}}},ce=ee(null);ce.displayName="PopoverContext";function le(e){let a=te(ce);if(a===null){let f=new Error(`<${e} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,le),f}return a}let ae=ee(null);ae.displayName="PopoverAPIContext";function ve(e){let a=te(ae);if(a===null){let f=new Error(`<${e} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,ve),f}return a}let Te=ee(null);Te.displayName="PopoverGroupContext";function Fe(){return te(Te)}let pe=ee(null);pe.displayName="PopoverPanelContext";function Ze(){return te(pe)}function et(e,a){return V(a.type,Qe,e,a)}let tt="div";function ot(e,a){var P;let{__demoMode:f=!1,...F}=e,O=z(null),l=Y(a,He(o=>{O.current=o})),n=z([]),x=xe(et,{__demoMode:f,popoverState:f?0:1,buttons:n,button:null,buttonId:null,panel:null,panelId:null,beforePanelSentinel:me(),afterPanelSentinel:me()}),[{popoverState:t,button:p,buttonId:S,panel:s,panelId:k,beforePanelSentinel:m,afterPanelSentinel:T},d]=x,i=se((P=O.current)!=null?P:p),E=D(()=>{if(!p||!s)return!1;for(let v of document.querySelectorAll("body > *"))if(Number(v==null?void 0:v.contains(p))^Number(v==null?void 0:v.contains(s)))return!0;let o=Pe(),u=o.indexOf(p),c=(u+o.length-1)%o.length,R=(u+1)%o.length,M=o[c],r=o[R];return!s.contains(M)&&!s.contains(r)},[p,s]),C=Ee(S),b=Ee(k),L=D(()=>({buttonId:C,panelId:b,close:()=>d({type:1})}),[C,b,d]),A=Fe(),_=A==null?void 0:A.registerPopover,j=g(()=>{var o;return(o=A==null?void 0:A.isFocusWithinPopoverGroup())!=null?o:(i==null?void 0:i.activeElement)&&((p==null?void 0:p.contains(i.activeElement))||(s==null?void 0:s.contains(i.activeElement)))});oe(()=>_==null?void 0:_(L),[_,L]);let[$,J]=Ye(),B=Ge({mainTreeNodeRef:A==null?void 0:A.mainTreeNodeRef,portals:$,defaultContainers:[p,s]});Le(i==null?void 0:i.defaultView,"focus",o=>{var u,c,R,M;o.target!==window&&o.target instanceof HTMLElement&&t===0&&(j()||p&&s&&(B.contains(o.target)||(c=(u=m.current)==null?void 0:u.contains)!=null&&c.call(u,o.target)||(M=(R=T.current)==null?void 0:R.contains)!=null&&M.call(R,o.target)||d({type:1})))},!0),Be(B.resolveContainers,(o,u)=>{d({type:1}),je(u,Ke.Loose)||(o.preventDefault(),p==null||p.focus())},t===0);let h=g(o=>{d({type:1});let u=(()=>o?o instanceof HTMLElement?o:"current"in o&&o.current instanceof HTMLElement?o.current:p:p)();u==null||u.focus()}),G=D(()=>({close:h,isPortalled:E}),[h,E]),w=D(()=>({open:t===0,close:h}),[t,h]),X={ref:l};return y.createElement(Ne,null,y.createElement(pe.Provider,{value:null},y.createElement(ce.Provider,{value:x},y.createElement(ae.Provider,{value:G},y.createElement(Ve,{value:V(t,{[0]:q.Open,[1]:q.Closed})},y.createElement(J,null,Z({ourProps:X,theirProps:F,slot:w,defaultTag:tt,name:"Popover"}),y.createElement(B.MainTreeNode,null)))))))}let rt="button";function nt(e,a){var c,R,M;let f=re(),{id:F=`headlessui-popover-button-${f}`,...O}=e,[l,n]=le("Popover.Button"),{isPortalled:x}=ve("Popover.Button"),t=z(null),p=`headlessui-focus-sentinel-${re()}`,S=Fe(),s=S==null?void 0:S.closeOthers,m=Ze()!==null;oe(()=>{if(!m)return n({type:3,buttonId:F}),()=>{n({type:3,buttonId:null})}},[m,F,n]);let[T]=ye(()=>Symbol()),d=Y(t,a,Ue(),m?null:r=>{if(r)l.buttons.current.push(T);else{let v=l.buttons.current.indexOf(T);v!==-1&&l.buttons.current.splice(v,1)}l.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),r&&n({type:2,button:r})}),i=Y(t,a),E=se(t),C=g(r=>{var v,I,U;if(m){if(l.popoverState===1)return;switch(r.key){case K.Space:case K.Enter:r.preventDefault(),(I=(v=r.target).click)==null||I.call(v),n({type:1}),(U=l.button)==null||U.focus();break}}else switch(r.key){case K.Space:case K.Enter:r.preventDefault(),r.stopPropagation(),l.popoverState===1&&(s==null||s(l.buttonId)),n({type:0});break;case K.Escape:if(l.popoverState!==0)return s==null?void 0:s(l.buttonId);if(!t.current||E!=null&&E.activeElement&&!t.current.contains(E.activeElement))return;r.preventDefault(),r.stopPropagation(),n({type:1});break}}),b=g(r=>{m||r.key===K.Space&&r.preventDefault()}),L=g(r=>{var v,I;Ae(r.currentTarget)||e.disabled||(m?(n({type:1}),(v=l.button)==null||v.focus()):(r.preventDefault(),r.stopPropagation(),l.popoverState===1&&(s==null||s(l.buttonId)),n({type:0}),(I=l.button)==null||I.focus()))}),A=g(r=>{r.preventDefault(),r.stopPropagation()}),{isFocusVisible:_,focusProps:j}=Oe({autoFocus:(c=e.autoFocus)!=null?c:!1}),{isHovered:$,hoverProps:J}=Ce({isDisabled:(R=e.disabled)!=null?R:!1}),{pressed:B,pressProps:h}=_e({disabled:(M=e.disabled)!=null?M:!1}),G=l.popoverState===0,w=D(()=>{var r;return{open:G,active:B||G,hover:$,focus:_,autofocus:(r=e.autoFocus)!=null?r:!1}},[G,$,_,B,e.autoFocus]),X=he(e,t),P=m?de({ref:i,type:X,onKeyDown:C,onClick:L},j,J,h):de({ref:d,id:l.buttonId,type:X,"aria-expanded":l.popoverState===0,"aria-controls":l.panel?l.panelId:void 0,onKeyDown:C,onKeyUp:b,onClick:L,onMouseDown:A},j,J,h),o=be(),u=g(()=>{let r=l.panel;if(!r)return;function v(){V(o.current,{[H.Forwards]:()=>W(r,N.First),[H.Backwards]:()=>W(r,N.Last)})===fe.Error&&W(Pe().filter(U=>U.dataset.headlessuiFocusGuard!=="true"),V(o.current,{[H.Forwards]:N.Next,[H.Backwards]:N.Previous}),{relativeTo:l.button})}v()});return y.createElement(y.Fragment,null,Z({ourProps:P,theirProps:O,slot:w,defaultTag:rt,name:"Popover.Button"}),G&&!m&&x&&y.createElement(ue,{id:p,features:ie.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:u}))}let lt="div",at=ne.RenderStrategy|ne.Static;function pt(e,a){let f=re(),{id:F=`headlessui-popover-overlay-${f}`,...O}=e,[{popoverState:l},n]=le("Popover.Overlay"),x=Y(a),t=Se(),p=(()=>t!==null?(t&q.Open)===q.Open:l===0)(),S=g(m=>{if(Ae(m.currentTarget))return m.preventDefault();n({type:1})}),s=D(()=>({open:l===0}),[l]);return Z({ourProps:{ref:x,id:F,"aria-hidden":!0,onClick:S},theirProps:O,slot:s,defaultTag:lt,features:at,visible:p,name:"Popover.Overlay"})}let st="div",ut=ne.RenderStrategy|ne.Static;function it(e,a){let f=re(),{id:F=`headlessui-popover-panel-${f}`,focus:O=!1,anchor:l,modal:n,...x}=e,[t,p]=le("Popover.Panel"),{close:S,isPortalled:s}=ve("Popover.Panel"),k=`headlessui-focus-sentinel-before-${f}`,m=`headlessui-focus-sentinel-after-${f}`,T=z(null),[d,i]=ke(l),E=we();l!=null&&n==null?n=!0:n==null&&(n=!1);let C=Y(T,a,l?d:null,P=>{p({type:4,panel:P})}),b=se(T),L=Je();Ie(()=>(p({type:5,panelId:F}),()=>{p({type:5,panelId:null})}),[F,p]);let A=Se(),_=(()=>A!==null?(A&q.Open)===q.Open:t.popoverState===0)(),j=g(P=>{var o;switch(P.key){case K.Escape:if(t.popoverState!==0||!T.current||b!=null&&b.activeElement&&!T.current.contains(b.activeElement))return;P.preventDefault(),P.stopPropagation(),p({type:1}),(o=t.button)==null||o.focus();break}});oe(()=>{var P;e.static||t.popoverState===1&&((P=e.unmount)==null||P)&&p({type:4,panel:null})},[t.popoverState,e.unmount,e.static,p]),oe(()=>{if(t.__demoMode||!O||t.popoverState!==0||!T.current)return;let P=b==null?void 0:b.activeElement;T.current.contains(P)||W(T.current,N.First)},[t.__demoMode,O,T,t.popoverState]);let $=D(()=>({open:t.popoverState===0,close:S}),[t,S]),J=de(l?E():{},{ref:C,id:F,onKeyDown:j,onBlur:O&&t.popoverState===0?P=>{var u,c,R,M,r;let o=P.relatedTarget;o&&T.current&&((u=T.current)!=null&&u.contains(o)||(p({type:1}),((R=(c=t.beforePanelSentinel.current)==null?void 0:c.contains)!=null&&R.call(c,o)||(r=(M=t.afterPanelSentinel.current)==null?void 0:M.contains)!=null&&r.call(M,o))&&o.focus({preventScroll:!0})))}:void 0,tabIndex:-1,...i?{style:i}:{}}),B=be(),h=g(()=>{let P=T.current;if(!P)return;function o(){V(B.current,{[H.Forwards]:()=>{var c;W(P,N.First)===fe.Error&&((c=t.afterPanelSentinel.current)==null||c.focus())},[H.Backwards]:()=>{var u;(u=t.button)==null||u.focus({preventScroll:!0})}})}o()}),G=g(()=>{let P=T.current;if(!P)return;function o(){V(B.current,{[H.Forwards]:()=>{var v;if(!t.button)return;let u=Pe(),c=u.indexOf(t.button),R=u.slice(0,c+1),r=[...u.slice(c+1),...R];for(let I of r.slice())if(I.dataset.headlessuiFocusGuard==="true"||(v=t.panel)!=null&&v.contains(I)){let U=r.indexOf(I);U!==-1&&r.splice(U,1)}W(r,N.First,{sorted:!1})},[H.Backwards]:()=>{var c;W(P,N.Previous)===fe.Error&&((c=t.button)==null||c.focus())}})}o()}),w=n?ge:l?Re:Me,X=n?{focusTrapFeatures:Xe.None,features:We.ScrollLock,enabled:t.popoverState===0}:{};return(w===Re||w===ge)&&(s=!0),y.createElement(pe.Provider,{value:F},y.createElement(ae.Provider,{value:{close:S,isPortalled:s}},y.createElement(w,{...X},_&&s&&y.createElement(ue,{id:k,ref:t.beforePanelSentinel,features:ie.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:h}),Z({mergeRefs:L,ourProps:J,theirProps:x,slot:$,defaultTag:st,features:ut,visible:_,name:"Popover.Panel"}),_&&s&&y.createElement(ue,{id:m,ref:t.afterPanelSentinel,features:ie.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:G}))))}let ft="div";function Pt(e,a){let f=z(null),F=Y(f,a),[O,l]=ye([]),n=De(),x=g(d=>{l(i=>{let E=i.indexOf(d);if(E!==-1){let C=i.slice();return C.splice(E,1),C}return i})}),t=g(d=>(l(i=>[...i,d]),()=>x(d))),p=g(()=>{var E;let d=$e(f);if(!d)return!1;let i=d.activeElement;return(E=f.current)!=null&&E.contains(i)?!0:O.some(C=>{var b,L;return((b=d.getElementById(C.buttonId.current))==null?void 0:b.contains(i))||((L=d.getElementById(C.panelId.current))==null?void 0:L.contains(i))})}),S=g(d=>{for(let i of O)i.buttonId.current!==d&&i.close()}),s=D(()=>({registerPopover:t,unregisterPopover:x,isFocusWithinPopoverGroup:p,closeOthers:S,mainTreeNodeRef:n.mainTreeNodeRef}),[t,x,p,S,n.mainTreeNodeRef]),k=D(()=>({}),[]),m=e,T={ref:F};return y.createElement(Te.Provider,{value:s},Z({ourProps:T,theirProps:m,slot:k,defaultTag:ft,name:"Popover.Group"}),y.createElement(n.MainTreeNode,null))}let dt=Q(ot),ct=Q(nt),vt=Q(pt),Tt=Q(it),mt=Q(Pt),Jt=Object.assign(dt,{Button:ct,Overlay:vt,Panel:Tt,Group:mt});export{Jt as Popover,ct as PopoverButton,mt as PopoverGroup,vt as PopoverOverlay,Tt as PopoverPanel};
