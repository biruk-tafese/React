"use client";import{useFocusRing as Se}from"@react-aria/focus";import{useHover as Re}from"@react-aria/interactions";import D,{Fragment as Z,createContext as ee,createRef as Pe,useCallback as pe,useContext as te,useEffect as ue,useMemo as N,useReducer as Ae,useRef as V,useState as Ee}from"react";import{useActivePress as he}from'../../hooks/use-active-press.js';import{useByComparator as De}from'../../hooks/use-by-comparator.js';import{useComputed as Ie}from'../../hooks/use-computed.js';import{useControllable as _e}from'../../hooks/use-controllable.js';import{useDidElementMove as Fe}from'../../hooks/use-did-element-move.js';import{useDisposables as X}from'../../hooks/use-disposables.js';import{useElementSize as Ce}from'../../hooks/use-element-size.js';import{useEvent as O}from'../../hooks/use-event.js';import{useId as oe}from'../../hooks/use-id.js';import{useIsoMorphicEffect as ne}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Me}from'../../hooks/use-latest-value.js';import{useOutsideClick as we}from'../../hooks/use-outside-click.js';import{useResolveButtonType as ke}from'../../hooks/use-resolve-button-type.js';import{useSyncRefs as j}from'../../hooks/use-sync-refs.js';import{useTextValue as Be}from'../../hooks/use-text-value.js';import{useTrackedPointer as Ue}from'../../hooks/use-tracked-pointer.js';import{useDisabled as Ne}from'../../internal/disabled.js';import{FloatingProvider as Ge,useFloatingPanel as Ve,useFloatingPanelProps as He,useFloatingReference as je,useFloatingReferenceProps as We}from'../../internal/floating.js';import{FormFields as ze}from'../../internal/form-fields.js';import{useProvidedId as Ke}from'../../internal/id.js';import{Modal as Qe}from'../../internal/modal.js';import{OpenClosedProvider as Xe,State as J,useOpenClosed as Je}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as $e}from'../../utils/bugs.js';import{Focus as y,calculateActiveIndex as ie}from'../../utils/calculate-active-index.js';import{disposables as re}from'../../utils/disposables.js';import{FocusableMode as qe,isFocusableElement as Ye,sortByDomNode as Ze}from'../../utils/focus-management.js';import{match as H}from'../../utils/match.js';import{getOwnerDocument as et}from'../../utils/owner.js';import{RenderFeatures as de,forwardRefWithAs as W,mergeProps as ce,render as z}from'../../utils/render.js';import{useDescribedBy as tt}from'../description/description.js';import{Keys as S}from'../keyboard.js';import{Label as ot,useLabelledBy as nt,useLabels as it}from'../label/label.js';import{Portal as rt}from'../portal/portal.js';var at=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(at||{}),lt=(o=>(o[o.Single=0]="Single",o[o.Multi=1]="Multi",o))(lt||{}),st=(o=>(o[o.Pointer=0]="Pointer",o[o.Other=1]="Other",o))(st||{}),pt=(t=>(t[t.OpenListbox=0]="OpenListbox",t[t.CloseListbox=1]="CloseListbox",t[t.GoToOption=2]="GoToOption",t[t.Search=3]="Search",t[t.ClearSearch=4]="ClearSearch",t[t.RegisterOption=5]="RegisterOption",t[t.UnregisterOption=6]="UnregisterOption",t))(pt||{});function ae(e,i=o=>o){let o=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,r=Ze(i(e.options.slice()),c=>c.dataRef.current.domRef.current),n=o?r.indexOf(o):null;return n===-1&&(n=null),{options:r,activeOptionIndex:n}}let ut={[1](e){return e.dataRef.current.disabled||e.listboxState===1?e:{...e,activeOptionIndex:null,listboxState:1}},[0](e){if(e.dataRef.current.disabled||e.listboxState===0)return e;let i=e.activeOptionIndex,{isSelected:o}=e.dataRef.current,r=e.options.findIndex(n=>o(n.dataRef.current.value));return r!==-1&&(i=r),{...e,listboxState:0,activeOptionIndex:i}},[2](e,i){var c,s,t,l,d;if(e.dataRef.current.disabled||e.listboxState===1)return e;let o={...e,searchQuery:"",activationTrigger:(c=i.trigger)!=null?c:1};if(i.focus===y.Nothing)return{...o,activeOptionIndex:null};if(i.focus===y.Specific)return{...o,activeOptionIndex:e.options.findIndex(p=>p.id===i.id)};if(i.focus===y.Previous){let p=e.activeOptionIndex;if(p!==null){let m=e.options[p].dataRef.current.domRef,T=ie(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:b=>b.id,resolveDisabled:b=>b.dataRef.current.disabled});if(T!==null){let b=e.options[T].dataRef.current.domRef;if(((s=m.current)==null?void 0:s.previousElementSibling)===b.current||((t=b.current)==null?void 0:t.previousElementSibling)===null)return{...o,activeOptionIndex:T}}}}else if(i.focus===y.Next){let p=e.activeOptionIndex;if(p!==null){let m=e.options[p].dataRef.current.domRef,T=ie(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:b=>b.id,resolveDisabled:b=>b.dataRef.current.disabled});if(T!==null){let b=e.options[T].dataRef.current.domRef;if(((l=m.current)==null?void 0:l.nextElementSibling)===b.current||((d=b.current)==null?void 0:d.nextElementSibling)===null)return{...o,activeOptionIndex:T}}}}let r=ae(e),n=ie(i,{resolveItems:()=>r.options,resolveActiveIndex:()=>r.activeOptionIndex,resolveId:p=>p.id,resolveDisabled:p=>p.dataRef.current.disabled});return{...o,...r,activeOptionIndex:n}},[3]:(e,i)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let r=e.searchQuery!==""?0:1,n=e.searchQuery+i.value.toLowerCase(),s=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+r).concat(e.options.slice(0,e.activeOptionIndex+r)):e.options).find(l=>{var d;return!l.dataRef.current.disabled&&((d=l.dataRef.current.textValue)==null?void 0:d.startsWith(n))}),t=s?e.options.indexOf(s):-1;return t===-1||t===e.activeOptionIndex?{...e,searchQuery:n}:{...e,searchQuery:n,activeOptionIndex:t,activationTrigger:1}},[4](e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},[5]:(e,i)=>{let o={id:i.id,dataRef:i.dataRef},r=ae(e,n=>[...n,o]);return e.activeOptionIndex===null&&e.dataRef.current.isSelected(i.dataRef.current.value)&&(r.activeOptionIndex=r.options.indexOf(o)),{...e,...r}},[6]:(e,i)=>{let o=ae(e,r=>{let n=r.findIndex(c=>c.id===i.id);return n!==-1&&r.splice(n,1),r});return{...e,...o,activationTrigger:1}}},le=ee(null);le.displayName="ListboxActionsContext";function $(e){let i=te(le);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,$),o}return i}let q=ee(null);q.displayName="ListboxDataContext";function K(e){let i=te(q);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,K),o}return i}function dt(e,i){return H(i.type,ut,e,i)}let ct=Z;function ft(e,i){var se;let o=Ne(),{value:r,defaultValue:n,form:c,name:s,onChange:t,by:l,invalid:d=!1,disabled:p=o||!1,horizontal:m=!1,multiple:T=!1,...b}=e;const C=m?"horizontal":"vertical";let k=j(i),[R=T?[]:void 0,P]=_e(r,t,n),[h,v]=Ae(dt,{dataRef:Pe(),listboxState:1,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1,optionsVisible:!1}),I=V({static:!1,hold:!1}),M=V(null),B=V(null),w=V(new Map),f=De(l),E=pe(x=>H(u.mode,{[1]:()=>R.some(L=>f(L,x)),[0]:()=>f(R,x)}),[R]),u=N(()=>({...h,value:R,disabled:p,invalid:d,mode:T?1:0,orientation:C,compare:f,isSelected:E,optionsPropsRef:I,buttonRef:M,optionsRef:B,listRef:w}),[R,p,d,T,h,w]);ne(()=>{h.dataRef.current=u},[u]),we([u.buttonRef,u.optionsRef],(x,L)=>{var _;v({type:1}),Ye(L,qe.Loose)||(x.preventDefault(),(_=u.buttonRef.current)==null||_.focus())},u.listboxState===0);let U=N(()=>({open:u.listboxState===0,disabled:p,invalid:d,value:R}),[u,p,R,d]),g=O(x=>{let L=u.options.find(_=>_.id===x);L&&Y(L.dataRef.current.value)}),G=O(()=>{if(u.activeOptionIndex!==null){let{dataRef:x,id:L}=u.options[u.activeOptionIndex];Y(x.current.value),v({type:2,focus:y.Specific,id:L})}}),Q=O(()=>v({type:0})),a=O(()=>v({type:1})),A=X(),F=O((x,L,_)=>{A.dispose(),A.microTask(()=>x===y.Specific?v({type:2,focus:y.Specific,id:L,trigger:_}):v({type:2,focus:x,trigger:_}))}),be=O((x,L)=>(v({type:5,id:x,dataRef:L}),()=>v({type:6,id:x}))),Y=O(x=>H(u.mode,{[0](){return P==null?void 0:P(x)},[1](){let L=u.value.slice(),_=L.findIndex(Le=>f(Le,x));return _===-1?L.push(x):L.splice(_,1),P==null?void 0:P(L)}})),Te=O(x=>v({type:3,value:x})),xe=O(()=>v({type:4})),me=N(()=>({onChange:Y,registerOption:be,goToOption:F,closeListbox:a,openListbox:Q,selectActiveOption:G,selectOption:g,search:Te,clearSearch:xe}),[]),[Oe,ye]=it({inherit:!0}),ve={ref:k},ge=pe(()=>P==null?void 0:P(n),[P]);return D.createElement(ye,{value:Oe,props:{htmlFor:(se=u.buttonRef.current)==null?void 0:se.id},slot:{open:u.listboxState===0,disabled:p}},D.createElement(Ge,null,D.createElement(le.Provider,{value:me},D.createElement(q.Provider,{value:u},D.createElement(Xe,{value:H(u.listboxState,{[0]:J.Open,[1]:J.Closed})},s!=null&&R!=null&&D.createElement(ze,{data:{[s]:R},form:c,onReset:ge}),z({ourProps:ve,theirProps:b,slot:U,defaultTag:ct,name:"Listbox"}))))))}let bt="button";function Tt(e,i){var f,E,u,U;let o=oe(),r=Ke(),{id:n=r||`headlessui-listbox-button-${o}`,...c}=e,s=K("Listbox.Button"),t=$("Listbox.Button"),l=j(s.buttonRef,i,je()),d=We(),p=X(),m=O(g=>{switch(g.key){case S.Space:case S.Enter:case S.ArrowDown:g.preventDefault(),t.openListbox(),p.nextFrame(()=>{s.value||t.goToOption(y.First)});break;case S.ArrowUp:g.preventDefault(),t.openListbox(),p.nextFrame(()=>{s.value||t.goToOption(y.Last)});break}}),T=O(g=>{switch(g.key){case S.Space:g.preventDefault();break}}),b=O(g=>{if($e(g.currentTarget))return g.preventDefault();s.listboxState===0?(t.closeListbox(),p.nextFrame(()=>{var G;return(G=s.buttonRef.current)==null?void 0:G.focus({preventScroll:!0})})):(g.preventDefault(),t.openListbox())}),C=nt([n]),k=tt(),{isFocusVisible:R,focusProps:P}=Se({autoFocus:(f=e.autoFocus)!=null?f:!1}),{isHovered:h,hoverProps:v}=Re({isDisabled:(E=s.disabled)!=null?E:!1}),{pressed:I,pressProps:M}=he({disabled:(u=s.disabled)!=null?u:!1}),B=N(()=>{var g;return{open:s.listboxState===0,active:I||s.listboxState===0,disabled:s.disabled,invalid:s.invalid,value:s.value,hover:h,focus:R,autofocus:(g=e.autoFocus)!=null?g:!1}},[s.listboxState,s.disabled,s.value,h,R,I,s.invalid,e.autoFocus]),w=ce(d(),{ref:l,id:n,type:ke(e,s.buttonRef),"aria-haspopup":"listbox","aria-controls":(U=s.optionsRef.current)==null?void 0:U.id,"aria-expanded":s.listboxState===0,"aria-labelledby":C,"aria-describedby":k,disabled:s.disabled,onKeyDown:m,onKeyUp:T,onClick:b},P,v,M);return z({ourProps:w,theirProps:c,slot:B,defaultTag:bt,name:"Listbox.Button"})}let fe=ee(!1),xt="ul",mt=de.RenderStrategy|de.Static;function Ot(e,i){var Q;let o=oe(),{id:r=`headlessui-listbox-options-${o}`,anchor:n,modal:c,...s}=e;n!=null&&c==null?c=!0:c==null&&(c=!1);let t=K("Listbox.Options"),l=$("Listbox.Options"),d=Je(),p=(()=>d!==null?(d&J.Open)===J.Open:t.listboxState===0)(),m=V(null);ue(()=>{var A;if(!((A=n==null?void 0:n.to)!=null&&A.includes("selection")))return;if(!p){m.current=null;return}let a=Array.from(t.listRef.current.values());m.current=a.findIndex(F=>(F==null?void 0:F.dataset.selected)===""),m.current===-1&&(m.current=a.findIndex(F=>(F==null?void 0:F.dataset.disabled)===void 0),l.goToOption(y.First))},[p,t.listRef]);let b=Fe(t.buttonRef,t.listboxState!==0)?!1:p,C=(()=>{if(n==null)return;if(t.listRef.current.size<=0)return{...n,inner:void 0};let a=Array.from(t.listRef.current.values());return{...n,inner:{listRef:{current:a},index:m.current}}})(),[k,R]=Ve(C),P=He(),h=j(t.optionsRef,i,n?k:null),v=X(),I=X();ue(()=>{var A;let a=t.optionsRef.current;a&&t.listboxState===0&&a!==((A=et(a))==null?void 0:A.activeElement)&&(a==null||a.focus({preventScroll:!0}))},[t.listboxState,t.optionsRef]);let M=O(a=>{switch(I.dispose(),a.key){case S.Space:if(t.searchQuery!=="")return a.preventDefault(),a.stopPropagation(),l.search(a.key);case S.Enter:if(a.preventDefault(),a.stopPropagation(),t.activeOptionIndex!==null){let{dataRef:A}=t.options[t.activeOptionIndex];l.onChange(A.current.value)}t.mode===0&&(l.closeListbox(),re().nextFrame(()=>{var A;return(A=t.buttonRef.current)==null?void 0:A.focus({preventScroll:!0})}));break;case H(t.orientation,{vertical:S.ArrowDown,horizontal:S.ArrowRight}):return a.preventDefault(),a.stopPropagation(),l.goToOption(y.Next);case H(t.orientation,{vertical:S.ArrowUp,horizontal:S.ArrowLeft}):return a.preventDefault(),a.stopPropagation(),l.goToOption(y.Previous);case S.Home:case S.PageUp:return a.preventDefault(),a.stopPropagation(),l.goToOption(y.First);case S.End:case S.PageDown:return a.preventDefault(),a.stopPropagation(),l.goToOption(y.Last);case S.Escape:return a.preventDefault(),a.stopPropagation(),l.closeListbox(),v.nextFrame(()=>{var A;return(A=t.buttonRef.current)==null?void 0:A.focus({preventScroll:!0})});case S.Tab:a.preventDefault(),a.stopPropagation();break;default:a.key.length===1&&(l.search(a.key),I.setTimeout(()=>l.clearSearch(),350));break}}),B=Ie(()=>{var a;return(a=t.buttonRef.current)==null?void 0:a.id},[t.buttonRef.current]),w=N(()=>({open:t.listboxState===0}),[t]),f=ce(n?P():{},{id:r,ref:h,"aria-activedescendant":t.activeOptionIndex===null||(Q=t.options[t.activeOptionIndex])==null?void 0:Q.id,"aria-multiselectable":t.mode===1?!0:void 0,"aria-labelledby":B,"aria-orientation":t.orientation,onKeyDown:M,role:"listbox",tabIndex:0,style:{...R,"--button-width":Ce(t.buttonRef,!0).width}}),E=c?Qe:n?rt:Z,u=c?{enabled:t.listboxState===0}:{},[U,g]=Ee(t.value);t.value!==U&&t.listboxState===0&&t.mode!==1&&g(t.value);let G=O(a=>t.compare(U,a));return D.createElement(E,{...u},D.createElement(q.Provider,{value:t.mode===1?t:{...t,isSelected:G}},z({ourProps:f,theirProps:s,slot:w,defaultTag:xt,features:mt,visible:b,name:"Listbox.Options"})))}let yt="li";function vt(e,i){let o=oe(),{id:r=`headlessui-listbox-option-${o}`,disabled:n=!1,value:c,...s}=e,t=te(fe)===!0,l=K("Listbox.Option"),d=$("Listbox.Option"),p=l.activeOptionIndex!==null?l.options[l.activeOptionIndex].id===r:!1,m=l.isSelected(c),T=V(null),b=Be(T),C=Me({disabled:n,value:c,domRef:T,get textValue(){return b()}}),k=j(i,T,f=>{f?l.listRef.current.set(r,f):l.listRef.current.delete(r)});ne(()=>{if(l.listboxState!==0||!p||l.activationTrigger===0)return;let f=re();return f.requestAnimationFrame(()=>{var E,u;(u=(E=T.current)==null?void 0:E.scrollIntoView)==null||u.call(E,{block:"nearest"})}),f.dispose},[T,p,l.listboxState,l.activationTrigger,l.activeOptionIndex]),ne(()=>{if(!t)return d.registerOption(r,C)},[C,r,t]);let R=O(f=>{if(n)return f.preventDefault();d.onChange(c),l.mode===0&&(d.closeListbox(),re().nextFrame(()=>{var E;return(E=l.buttonRef.current)==null?void 0:E.focus({preventScroll:!0})}))}),P=O(()=>{if(n)return d.goToOption(y.Nothing);d.goToOption(y.Specific,r)}),h=Ue(),v=O(f=>{h.update(f),!n&&(p||d.goToOption(y.Specific,r,0))}),I=O(f=>{h.wasMoved(f)&&(n||p||d.goToOption(y.Specific,r,0))}),M=O(f=>{h.wasMoved(f)&&(n||p&&d.goToOption(y.Nothing))}),B=N(()=>({active:p,focus:p,selected:m,disabled:n,selectedOption:m&&t}),[p,m,n,t]),w=t?{}:{id:r,ref:k,role:"option",tabIndex:n===!0?void 0:-1,"aria-disabled":n===!0?!0:void 0,"aria-selected":m,disabled:void 0,onClick:R,onFocus:P,onPointerEnter:v,onMouseEnter:v,onPointerMove:I,onMouseMove:I,onPointerLeave:M,onMouseLeave:M};return!m&&t?null:z({ourProps:w,theirProps:s,slot:B,defaultTag:yt,name:"Listbox.Option"})}let gt=Z;function Lt(e,i){let{options:o,placeholder:r,...n}=e,s={ref:j(i)},t=K("ListboxSelectedOption"),l=N(()=>({}),[]),d=t.value===void 0||t.value===null||t.mode===1&&Array.isArray(t.value)&&t.value.length===0;return D.createElement(fe.Provider,{value:!0},z({ourProps:s,theirProps:{...n,children:D.createElement(D.Fragment,null,r&&d?r:o)},slot:l,defaultTag:gt,name:"ListboxSelectedOption"}))}let St=W(ft),Rt=W(Tt),Pt=ot,At=W(Ot),Et=W(vt),uo=W(Lt),co=Object.assign(St,{Button:Rt,Label:Pt,Options:At,Option:Et});export{co as Listbox,Rt as ListboxButton,Pt as ListboxLabel,Et as ListboxOption,At as ListboxOptions,uo as ListboxSelectedOption};
